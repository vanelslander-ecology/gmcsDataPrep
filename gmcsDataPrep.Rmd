---
title: "gmcsDataPrep"
author: "Ian MS Eddy"
date: "21 January 2019; updated April 2024"
output:
  html_document:
    df_print: paged
    keep_md: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, results = "hold")
```

# Overview

This module uses climate data and permanent sampling plot data to prepare a multivariate mixed effect model of growth, mortality, and net biomass change.
The data includes BC, Alberta, Saskatchewan, Ontario, New Brunswick, and the first NFI PSP measurement, which is mainly western Canada.
However, because the module requires repeat measurements, this module should only be used with a `studyAreaLarge` that covers at a minimum part of these jurisdictions. 

The module does not estimate unobserved growth and mortality (trees that grew and died between census measurements).
The formulas are included as comments.
It is not advisable to estimate the unobserved mortality and growth of species, and although the multivariate model does not have a species term, we intended for the model to one day include species.
Consequently, we exclude unobserved mortality and growth (estimates are usually 0.5-1.5% of total growth and mortality, so no biggie). 

# Usage

```{r module_usage}
library(SpaDES)
library(LandR)
library(sf)
library(fasterize)
library(terra)

setPaths(modulePath = file.path("../"))
getPaths() # shows where the 4 relevant paths are

times <- list(start = 2011, end = 2012)

## the study area isn't necessary to test models;
## it is only used to satisfy climate data prep. Smaller is better.
studyArea <- randomStudyArea(size = 10000*6.25*400)
templateRaster <- rast(ext(studyArea), crs = crs(studyArea), res = c(500,500))
templateRaster <- setValues(templateRaster, 1)

#this is the contiguous ecoregions of the RIA. It is suggested that users pass a studyAreaPSP 
#it should represent a geographic area where trees would be expected to have a similar climate response
studyAreaPSP <- prepInputs(url = "https://drive.google.com/open?id=10yhleaumhwa3hAv_8o7TE15lyesgkDV_",
                           destinationPath = tempdir())

parameters <- list(
  gmcsDataPrep = list(
    "minDBH" = 9, #the minimum DBH varies over time and space, so 9+ is recommended
    "useHeight" = TRUE,
    ".useCache" = FALSE,
    "PSPdataTypes" = "all",
    "PSPab_damageColsToExclude" = NULL,
    "PSPbc_damageColsToExclude" = NULL,
    "PSPnfi_damageColsToExclude" = NULL,
    "PSPperiod" = c(1958,2019),
    #an alternative mortality model - gamma not possible due to 0 
    "mortalityModel" = quote(glmmPQL(mortality ~ logAge*(ATA + CMI) + logAge^2 *(ATA + CMI) + ATA*CMI, random = ~1 | OrigPlotID1,
                                    weights = scale(PSPmodelData$plotSize^0.5 * PSPmodelData$periodLength, center = FALSE),
                                    data = PSPmodelData, family = "gaussian"(link = 'identity'))),
    #the 'new' growth model with quadratic. 
    "growthModel" = quote(glmmPQL(growth ~ logAge*(ATA + CMI) + logAge^2 * (CMI + ATA) + ATA:CMI, random = ~1 | OrigPlotID1,
                                    weights = scale(PSPmodelData$plotSize^0.5 * PSPmodelData$periodLength, center = FALSE),
                                    data = PSPmodelData, family = 'Gamma'(link = 'log'))),
    #the original model with quadratic term
    # "growthModel" = quote(nlme::lme(growth ~ logAge*(ATA + CMI) + logAge^2 *(ATA + CMI) + ATA*CMI, random = ~1 | OrigPlotID1,
    #                                 weights = varFunc(~plotSize^0.5 * periodLength), data = PSPmodelData)),
    #Yong's original growth model
    # "growthModel" = quote(nlme::lme(growth ~ logAge*(ATA + CMI) + ATA*CMI, random = ~1 | OrigPlotID1,
    #                                  weights = varFunc(~plotSize^0.5 * periodLength), data = PSPmodelData)),
    "PSPvalidationPeriod" = NULL #pass NULL to instead randomly sample the validation data
  )
)


modules <- list("gmcsDataPrep")
objects <- list(studyArea = studyArea, 
                rasterToMatch = templateRaster,
                studyAreaPSP = studyAreaPSP)
inputs <- list()
outputs <- list()

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects)

mySimOut <- spades(mySim)

```

# Parameters

Provide a summary of user-visible parameters.

```{r moduleParams, eval = TRUE, echo = FALSE, message=FALSE, warning=FALSE}
df_params <- SpaDES.core::moduleParams("gmcsDataPrep", "..")
knitr::kable(df_params)
```

# Events

- TODO

## Plotting

- TODO

## Saving

- TODO

# Data dependencies

## Input data

How to obtain input data, and a description of the data required by the module.
If `sourceURL` is specified, `downloadData("gmcsDataPrep", "path/to/modules/dir")` may be sufficient.

## Input data

How to obtain input data, and a description of the data required by the module.
If `sourceURL` is specified, `downloadData("canClimateData", "..")` may be sufficient.

```{r moduleInputs, eval = TRUE, echo = FALSE, message=FALSE, warning=FALSE}
df_inputs <- SpaDES.core::moduleInputs("canClimateData", "..")
knitr::kable(df_inputs)
```

## Output data

Description of the module outputs.

```{r moduleOutputs, eval = TRUE, echo = FALSE, message=FALSE, warning=FALSE}
df_outputs <- SpaDES.core::moduleOutputs("canClimateData", "..")
knitr::kable(df_outputs)
```

# Links to other modules

- [Biomass_core](https://github.com/PredictiveEcology/Biomass_core)
